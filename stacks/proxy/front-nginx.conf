worker_processes auto;
events {}

http {
  # Forward HTTP for vulpe.dev and all subdomains to Dokploy VM
  server {
    listen 80;
    listen [::]:80;
    server_name vulpe.dev *.vulpe.dev;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    location / { proxy_pass http://192.168.1.103:80; }
  }

  # Everything else on HTTP → NPM (same docker network)
  server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    location / { proxy_pass http://npm:80; }
  }
}

stream {
  # SNI-based TCP forward for HTTPS only
  resolver 127.0.0.11 ipv6=off;

  map $ssl_preread_server_name $upstream_tls {
    vulpe.dev          192.168.1.103:443;
    ~^.*\.vulpe\.dev$  192.168.1.103:443;
    default            npm:443;   # all other domains → NPM
  }

  server {
    listen 443;
    listen [::]:443;
    ssl_preread on;
    proxy_pass $upstream_tls;
    # proxy_protocol on;  # enable only if both backends expect PROXY protocol
  }
}
