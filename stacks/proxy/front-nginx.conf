worker_processes auto;
events {}

http {
  resolver 127.0.0.11 ipv6=off;

  # vulpe.dev HTTP → Dokploy (ACME + redirects handled there)
  server {
    listen 80;
    listen [::]:80;
    server_name vulpe.dev *.vulpe.dev;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    location / { proxy_pass http://192.168.1.103:80; }
  }

  # everything else HTTP → NPM (container name)
  server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    location / { proxy_pass http://npm:80; }
  }
}

stream {
  resolver 127.0.0.11 ipv6=off;

  map $ssl_preread_server_name $up {
    vulpe.dev          192.168.1.103:443;
    ~^.*\.vulpe\.dev$  192.168.1.103:443;
    default            npm:443;     # to NPM over Docker network
  }

  server {
    listen 443;
    listen [::]:443;
    ssl_preread on;
    proxy_pass $up;
    # proxy_protocol on;  # only if backend expects it
  }
}
